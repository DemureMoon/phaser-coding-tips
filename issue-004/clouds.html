<!DOCTYPE HTML>
<html>
<head>
    <title>Platform Game(No Clouds)</title>
    <meta charset="utf-8">
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
</head>
<body>

    <div id="game"></div>

    <script type="text/javascript">

    var game = new Phaser.Game(1905, 995, Phaser.CANVAS, 'game');
    //game = new Phaser.Game(window.innerWidth * window.devicePixelRatio, window.innerHeight * window.devicePixelRatio, Phaser.CANVAS, 'gameArea');

    //scaleRatio = window.devicePixelRatio / 3;
    //myAsset.scale.setTo(scaleRatio, scaleRatio);

    var PhaserGame = function () {

        this.bg = null;
        this.trees = null;
        this.killScreen;
        this.titleScreen;

        this.player = null;

        this.stationary = null;
        this.bunnies = null;
        this.leftHeart = null;
        this.rightHeart = null;
        this.hunter = null;
        this.hunter2 = null;
        this.collectBunny = null;

        this.facing = 'left';
        this.jumpTimer = 0;
        this.cursors;
        this.locked = false;
        this.lockedTo = null;
        this.wasLocked = false;
        this.willJump = false;

        this.score = 0;
        this.health = 0;

    };

    PhaserGame.prototype = {

        init: function () {

            this.game.renderer.renderSession.roundPixels = true;

            // If y is multiplied by 2 it will change the height of the world and bunny spawn
            this.world.resize(640*7, 995);

            this.physics.startSystem(Phaser.Physics.ARCADE);

            // Player gravity
            this.physics.arcade.gravity.y = 330;

        },

        preload: function () {

            // We need this because the assets are on Amazon S3
            // Remove the next 2 lines if running locally
            // this.load.baseURL = 'http://files.phaser.io.s3.amazonaws.com/codingtips/issue004/';
            this.load.crossOrigin = 'anonymous';

            this.load.image('trees', 'assets/forest.png', 384, 116);
            this.load.image('background', 'assets/ForestTrees1905x995.png');
            this.load.image('platform', 'assets/OfficialPlatform134x32.png', 134, 32);
            this.load.spritesheet('flynn', 'assets/Flynn_Sprite_Sheet_990x52.png', 90, 52);
            this.load.spritesheet('bunny', 'assets/Bunny45x45.png', 45, 45);
            this.load.image('leftHeart', 'assets/HalfHeart19x30.pKianang');
            this.load.image('rightHeart', 'assets/RightHalfHeart21x30.png');
            this.load.image('hunter', 'assets/HunterBow79x128.png', 79, 128);
            this.load.image('hunter2', 'assets/HunterBow79x128.png', 79, 128);
            this.load.image('killScreen', 'assets/killScreen1905x995.png', 1905, 995);
            this.load.image('titleScreen', 'assets/titleScreen.png', 1905, 995,);
        },


            //---------TileSprite{x, y, width, height, key string, frame string}---------

            // x	number
            // The x coordinate (in world space) to position the TileSprite at.

            // y	number
            // The y coordinate (in world space) to position the TileSprite at.

            // width	number=The width of the TileSprite.

            // height number=The height of the TileSprite.

            // key	string | Phaser.RenderTexture | Phaser.BitmapData | PIXI.Texture
            // This is the image or texture used by the TileSprite during rendering. It can be a string which is a reference to the Phaser Image Cache entry, or an instance of a RenderTexture, PIXI.Texture or BitmapData.

            // frame	string | number
            // If this TileSprite is using part of a sprite sheet or texture atlas you can specify the exact frame to use by giving a string or numeric index.

        create: function () {

            this.background = this.add.tileSprite(0, 0, 2000, 1000, 'background');
            this.background.fixedToCamera = true;

            this.trees = this.add.tileSprite(0, 1000-116-18, 2000, 116, 'trees');
            this.trees.fixedToCamera = true;

            // Platforms that don't move
            this.stationary = this.add.physicsGroup();

            // PLatforms
            //1
            this.stationary.create(170, 330 + 515, 'platform');
            //2
            this.stationary.create(400, 290 + 515, 'platform');
            //3
            this.stationary.create(650, 230 + 515, 'platform');
            this.stationary.create(784, 230 + 515, 'platform');
            this.stationary.create(918, 230 + 515, 'platform');
            this.stationary.create(1052, 230 + 515, 'platform');
            //4
            this.stationary.create(1110, 100 + 515, 'platform');
            this.stationary.create(1244, 100 + 515, 'platform');
            this.stationary.create(1378, 100 + 515, 'platform');
            //5
            this.stationary.create(940, 10 + 515, 'platform');
            this.stationary.create(780, -70 + 515, 'platform');
            this.stationary.create(1200, 290 + 515, 'platform');
            this.stationary.create(1334, 290 + 515, 'platform');
            this.stationary.create(1468, 290 + 515, 'platform');
            this.stationary.create(1602, 290 + 515, 'platform');
            this.stationary.create(1850, 210 + 515, 'platform');
            this.stationary.create(1800, 330 + 515, 'platform');



            // Ground
            this.stationary.create(0, 450 + 515, 'platform');
            this.stationary.create(134, 450 + 515, 'platform');
            this.stationary.create(268, 450 + 515, 'platform');
            this.stationary.create(402, 450 + 515, 'platform');
            this.stationary.create(536, 450 + 515, 'platform');
            this.stationary.create(670, 450 + 515, 'platform');
            this.stationary.create(804, 450 + 515, 'platform');
            this.stationary.create(938, 450 + 515, 'platform');
            this.stationary.create(1072, 450 + 515, 'platform');
            this.stationary.create(1206, 450 + 515, 'platform');
            this.stationary.create(1340, 450 + 515, 'platform');
            this.stationary.create(1474, 450 + 515, 'platform');
            this.stationary.create(1608, 450 + 515, 'platform');
            this.stationary.create(1742, 450 + 515, 'platform');
            this.stationary.create(1876, 450 + 515, 'platform');
            this.stationary.create(2010, 450 + 515, 'platform');
            this.stationary.create(2144, 450 + 515, 'platform');
            this.stationary.create(2278, 450 + 515, 'platform');
            this.stationary.create(2412, 965, 'platform');
            this.stationary.create(2546, 965, 'platform');
            this.stationary.create(2680, 965, 'platform');
            this.stationary.create(2814, 965, 'platform');
            this.stationary.create(2948, 965, 'platform');
            this.stationary.create(3082, 965, 'platform');
            this.stationary.create(3216, 965, 'platform');
            this.stationary.create(3350, 965, 'platform');
            this.stationary.create(3484, 965, 'platform');
            this.stationary.create(3618, 965, 'platform');
            this.stationary.create(3752, 965, 'platform');
            this.stationary.create(3886, 965, 'platform');
            this.stationary.create(4020, 965, 'platform');
            this.stationary.create(4154, 965, 'platform');
            this.stationary.create(4288, 965, 'platform');
            this.stationary.create(4422, 965, 'platform');

            this.stationary.setAll('body.allowGravity', false);
            this.stationary.setAll('body.immovable', true);


            //-----------------Adding health bar-----------------------------
            // this.leftHeart = this.add.physicsGroup();7

            // this.leftHeart.create(10, 60, 'leftHeart');
            // this.leftHeart.setAll('body.allowGravity', false);
            // this.leftHeart.setAll('body.immovable', true);
            // this.leftHeart.fixedToCamera = true;

            // this.rightHeart = this.add.physicsGroup();

            // this.rightHeart.create(29, 60, 'rightHeart');
            // this.rightHeart.setAll('body.allowGravity', false);
            // this.rightHeart.setAll('body.immovable', true);
            // this.rightHeart.fixedToCamera = true;


            // Finally some bunnies to collect
            this.bunnies = game.add.group();

            // We will enable physics for any bunny that is created in this group
            this.bunnies.enableBody = true;


            // Here we'll create them randomly spaced apart
            for (var i = 3; i < 60; i++)
            {

                // Create a bunny inside of the 'bunnies' group
                // var bunny = this.bunnies.create(i * 70, 0, 'bunny');
                // Can change y value to change bunny spawn height
                var bunny = this.bunnies.create((i + Math.random()) * 90, 110, 'bunny');

                // Use anchor to allow bunny to be flipped on its centerlines
                // Use scale to reduce bunny size and allow image to flip   using negative values
                this.direction = this.rnd.between(-1, 1);

                // Look for rnd function without a range since 0 erases the bunny.
                bunny.anchor.setTo(0.5, 0.5);

                // bunny.scale.x = (.6 * this.rnd.integerInRange(-1, 1));
                // bunny.scale.x = (.6 * this.rnd.between(-1, 1));
                bunny.scale.x = (.6 * this.direction);
                bunny.scale.y = .6;

                // So the bunnies don't spawn off the map...?
                bunny.body.collideWorldBounds = true;

                // Multiply values by scale so bunnies sit on ground. Needs some work.
                // bunny.body.setSize(25, 25, 10, 20)

                //SMB: added semicolon
                bunny.body.setSize(25 * .5, 25 * .5, 10 * .5, 20 * .5);

                // Let gravity do its thing
                bunny.body.gravity.y = 300;

                // This just gives each bunny a slightly random bounce value
                bunny.body.bounce.y = 0.7 + Math.random() * 0.2;

//-------------------Second Bunny Group--------------------------

                var bunny = this.bunnies.create((i + Math.random()) * 90, 350, 'bunny');

                this.direction = this.rnd.between(-1, 1);
                bunny.anchor.setTo(0.5, 0.5);
                bunny.scale.x = (.6 * this.direction);
                bunny.scale.y = .6;
                bunny.body.collideWorldBounds = true;

                // SMB: added semicolon
                bunny.body.setSize(25 * .5, 25 * .5, 10 * .5, 20 * .5);
                bunny.body.gravity.y = 300;
                bunny.body.bounce.y = 0.7 + Math.random() * 0.2;
            }

            // The Player start position
            this.player = this.add.sprite(0, 300, 'flynn');
            this.physics.arcade.enable(this.player);

            //this.player.anchor.setTo(0.1, 0.1);
            this.player.body.collideWorldBounds = true;
            //(90, 52, 0, 0)
            this.player.body.setSize(90, 52, -10, 0);

            this.player.animations.add('right', [10, 9, 8, 7, 6], 10, true);
            this.player.animations.add('left', [0, 1, 2, 3, 4], 10, true);

            this.camera.follow(this.player);
            this.cursors = this.input.keyboard.createCursorKeys();


            // Display the score
            this.scoreText = game.add.text(13, 100, 'Score: 0', { fontSize: '32px', fill: '#000', });
            this.scoreText.fixedToCamera = true;

            this.cursors = this.input.keyboard.createCursorKeys();

//-----------------------------Adding Hunters--------------------------------

            // Initializing the Hunter
            // this.hunter = game.add.group();
            this.hunter = this.add.sprite(Math.random() * 1000, Math.random() * 1000, 'hunter');
            this.hunterDirection = this.rnd.between(-1, 1);
            this.hunter.anchor.setTo(0.5, 0.5);

            // We will enable physics for any hunter that is created in this group
            //this.hunter.enableBody = true;
            this.physics.arcade.enable(this.hunter);

                this.hunter.scale.x = (.6 * this.hunterDirection);
                this.hunter.anchor.setTo(0.5, 0.5);
                this.hunter.scale.y = .6;

                this.hunter.body.collideWorldBounds = true;

                // Huter size (might make x value smaller so it's possibly easier not to hit the hunter if Flynn gets too close)
                //hunter.body.setSize(35, 128, 0, 0);

                // Gravity
                this.hunter.body.gravity.y = 300;

                // Hunter bounce
                this.hunter.body.bounce.y = Math.random() * .8;

                // Hunter movement
                this.hunter.body.velocity.x = -100 * this.hunterDirection;

//-----Second Hunter-----
            this.hunter2 = this.add.sprite(Math.random() * 1000, Math.random() * 1000, 'hunter2');
            this.hunter2Direction = this.rnd.between(-1, 1);
            this.hunter2.anchor.setTo(0.5, 0.5);

            this.physics.arcade.enable(this.hunter2);

            this.hunter2.scale.x = (.6 * this.hunter2Direction);
                this.hunter2.anchor.setTo(0.5, 0.5);
                this.hunter2.scale.y = .6;

                this.hunter2.body.collideWorldBounds = true;

            this.hunter2.body.gravity.y = 300;
            this.hunter2.body.bounce.y = Math.random() * .8;

            this.hunter2.body.velocity.x = -100 * this.hunter2Direction;

//-----------------------------Adding Health---------------------------------


            // Display Health Points
            this.healthText = game.add.text(13, 70, 'Health: 0', { fontsize: '32px', fill: '#F00', });
            this.healthText.fixedToCamera = true;

            // This doesn't seem to belong here. Probably copied by mistake
            // this.physics.arcade.collide(this.bunnies, this.stationary);
            //

            // Checks to see if the player overlaps with any of the bunnies, if he does call the collectBunny function
            this.game.physics.arcade.overlap(this.player, this.bunnies, this.collectBunny, null, this);

        },



        customSep: function (player, platform) {

            if (!this.locked && player.body.velocity.y > 0)
            {
                this.locked = true;
                this.lockedTo = platform;
                platform.playerLocked = true;

                player.body.velocity.y = 0;
            }

        },

        checkLock: function () {

            this.player.body.velocity.y = 0;

            // If the player has walked off either side of the platform then they're no longer locked to it
            if (this.player.body.right < this.lockedTo.body.x || this.player.body.x > this.lockedTo.body.right)
            {
                this.cancelLock();
            }

        },

        cancelLock: function () {

            this.wasLocked = true;
            this.locked = false;

        },

        preRender: function () {

            if (this.game.paused)
            {
                // Because preRender still runs even if your game pauses!
                return;
            }

            if (this.locked || this.wasLocked)
            {
                this.player.x += this.lockedTo.deltaX;
                this.player.y = this.lockedTo.y - 48;

                if (this.player.body.velocity.x !== 0)
                {
                    this.player.body.velocity.y = 0;
                }
            }

            if (this.willJump)
            {
                this.willJump = false;

                if (this.lockedTo && this.lockedTo.deltaY < 0 && this.wasLocked)
                {
                    // If the platform is moving up we add its velocity to the players jump
                    this.player.body.velocity.y = -300 + (this.lockedTo.deltaY * 10);
                }
                else
                {
                    this.player.body.velocity.y = -300;
                }

                this.jumpTimer = this.time.time + 750;
            }

            if (this.wasLocked)
            {
                this.wasLocked = false;
                this.lockedTo.playerLocked = false;
                this.lockedTo = null;
            }

        },

        update: function () {

            // Changes speed of backgrounds
            this.background.tilePosition.x = -(this.camera.x * 0.7);
            this.trees.tilePosition.x = -(this.camera.x * 0.9);

            this.physics.arcade.collide(this.player, this.stationary);


            // Do this AFTER the collide check, or we won't have blocked/touching set
            var standing = this.player.body.blocked.down || this.player.body.touching.down || this.locked;

            // Collide the player and the bunnies with the platforms

            this.physics.arcade.collide(this.bunnies, this.stationary);

            this.physics.arcade.collide(this.hunter, this.stationary);
            this.physics.arcade.collide(this.hunter2, this.stationary);


            // Checks to see if the player overlaps with any of the bunnies, if he does call the collectBunny function
            this.game.physics.arcade.overlap(this.player, this.bunnies, collectBunny, null, this);

            this.player.body.velocity.x = 0;

            //checks to see if player collides with hunters
            this.game.physics.arcade.overlap(this.player, this.hunter, loseHealth, null, this);
            this.game.physics.arcade.overlap(this.player, this.hunter2, loseHealth, null, this);

            this.player.body.velocity.x = 0;
            this.hunter2.body.velocity.x = -100 * this.hunter2Direction;
            this.hunter.body.velocity.x = -100 * this.hunterDirection;

            if (this.cursors.left.isDown)
            {
                this.player.body.velocity.x = -150;

                if (this.facing !== 'left')
                {
                    this.player.play('left');
                    this.facing = 'left';
                }
            }
            else if (this.cursors.right.isDown)
            {
                this.player.body.velocity.x = 150;

                if (this.facing !== 'right')
                {
                    this.player.play('right');
                    this.facing = 'right';
                }
            }
            else
            {
                if (this.facing !== 'idle')
                {
                    this.player.animations.stop();

                    if (this.facing === 'left')
                    {
                        this.player.frame = 5;
                    }
                    else
                    {
                        this.player.frame = 5;
                    }

                    this.facing = 'idle';
                }
            }
            
            if (standing && this.cursors.up.isDown && this.time.time > this.jumpTimer)
            {
                if (this.locked)
                {
                    this.cancelLock();
                }

                this.willJump = true;
            }

            if (this.locked)
            {
                this.checkLock();
            }

        },


    };

    // Added scoring
    function collectBunny (player, bunny) {

        // Removes the bunny from the screen
        // SMB: indented
        bunny.kill();
        this.score += 10;
        this.scoreText.text = 'Score: ' + this.score;
        this.health += 1;
        this.healthText.text = 'Health: ' + this.health;

    }

    //Losing health
    function loseHealth (player, hunter, hunter2) {
        //hunter.kill();
        //this.health -= 5;
        //this.healthText.text = 'Health:' + this.health;

        if (player.body.velocity.y > 0)
        {
            hunter.kill();
            this.health +=1;
            this.healthText.text = 'Health:' + this.health;
        }
        else
        {
            hunter.kill();
            this.health -=5;
            this.healthText.text = 'Health:' + this.health;
        }

        if (this.health < 0)
        {
            this.background = this.add.tileSprite(0, 0, 1905, 995, 'killScreen');
            this.camera.follow(this.background);
            //killScreen.onkeypress = function(){gameOver};
            setTimeout(gameOver, 2000);
        }
    // SMB: added missing end bracket
    }

    function gameOver () {
        game.state.start('Game');
    }


    game.state.add('Game', PhaserGame, true);

   </script>

</body>
</html>
